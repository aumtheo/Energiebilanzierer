<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Floorplanner mit Stockwerken</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <style>
    body {
  font-family: 'Roboto', sans-serif;
  margin: 0;
  background-color: #f0f0f0;
  min-height: 100vh;
  display: flex;
  justify-content: center;
}

#floorList {
      flex-grow: 1;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 5px;
      max-height: 300px;
      margin-bottom: 10px;
    }

    .floor-item {
      padding: 8px;
      background-color: #e0e0e0;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 5px;
    }

    .floor-item.active {
      background-color: #90caf9;
      font-weight: bold;
    }

#mainContainer {
  display: flex;
  flex-direction: row;
  width: 100%;
  height: 100vh;
}

#sidebar {
  width: 200px;
  background: #ffffff;
  padding: 20px;
  box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow-y: auto;
}

#canvasSection {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
}

#canvasControls {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-bottom: 20px;
}

#canvas {
  border: 2px solid #d3d3d3;
  border-radius: 8px;
  background-color: #f9f9f9;
}

#propertyForm {
  width: 300px;
  background: #ffffff;
  padding: 20px;
  box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
  display: none;
  flex-shrink: 0;
  overflow-y: auto;
}

#propertyForm label {
  font-weight: bold;
  margin-top: 10px;
}

#propertyForm input,
#propertyForm textarea {
  width: 100%;
  padding: 8px;
  margin-bottom: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

#propertyForm button {
  margin-top: 10px;
  padding: 10px;
  width: 48%;
  font-size: 14px;
  border-radius: 5px;
  border: none;
  cursor: pointer;
}

#applyProps {
  background-color: #4CAF50;
  color: white;
}

#deleteButton {
  background-color: #f44336;
  color: white;
}

#addFloor {
  background-color: #4CAF50;
  color: white;
  padding: 12px;
  border: none;
  border-radius: 5px;
  font-size: 16px;
  cursor: pointer;
  margin-bottom: 10px;
}

#createFloorButton {
  background-color: #2196F3;
  color: white;
  padding: 10px;
  border: none;
  border-radius: 5px;
  font-size: 14px;
  cursor: pointer;
  margin-top: 10px;
}


#deleteFloor {
  background-color: #f44336;
  color: white;
  padding: 12px;
  border: none;
  border-radius: 5px;
  font-size: 16px;
  cursor: pointer;
  margin-bottom: 10px;
}

#addRoom {
  background-color: #2196F3;
  color: white;
  padding: 12px;
  border: none;
  border-radius: 5px;
  font-size: 16px;
  cursor: pointer;
}



#exportButton {
  background-color: #2196F3;
  color: white;
  padding: 12px;
  border: none;
  border-radius: 5px;
  font-size: 16px;
  cursor: pointer;
}
.btn-continue {
  background: #5c6c3d;
  color: white;
  padding: 12px 30px;
  border-radius: 25px;
  border: none;
  font-size: 16px;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  transition: background .2s;
}
.btn-continue:hover {
  background: #4e5b34;
}


  </style>
</head>
<body>

<div id="mainContainer">
  <div id="sidebar">
    <button id="addFloor">+ Stockwerk</button>
    <button id="deleteFloor">- Stockwerk</button>
    <div id="floorList"></div>
  </div>

  <div id="canvasSection">
    <div id="canvasControls">
      <button id="addRoom">Raum hinzufügen</button>
      <button id="exportButton">Exportieren</button>
    </div>
    <canvas id="canvas" width="1000" height="700"></canvas>
  </div>

  <div id="propertyForm">
    <label>Name:</label>
    <textarea id="nameInput"></textarea>
    <label>Breite (m):</label>
    <input type="number" id="widthInput" />
    <label>Höhe (m):</label>
    <input type="number" id="heightInput" />
    <label>Notiz:</label>
    <textarea id="noteInput"></textarea>
    <label>Raumtyp:</label>
    <input type="text" id="roomTypeInput" />
    <button id="applyProps">Übernehmen</button>
    <button id="deleteButton">Raum löschen</button>
  </div>
</div>
<div class="buttons" style="text-align:center; margin:20px 0;">
  <a href="{% url 'grundriss' %}">
    <button type="button" class="btn-continue">Weiter → Grundriss</button>
  </a>
</div>
<script>
  const canvas = new fabric.Canvas('canvas', {
    selection: false
  });

  const grid = 50;
  const snapTolerance = 15;

  // Alle Stockwerke (gespeichert als JSON-Objekte)
  let floors = {};
  let currentFloor = null;
  let floorCounter = 0;

  const originPoint = new fabric.Circle({
  left: 0,
  top: 0,
  radius: 5,
  fill: 'red',
  selectable: false,
  evented: false,
  originX: 'center',
  originY: 'center'
});

  function saveCurrentFloor() {
    if (currentFloor !== null) {
      const objects = canvas.getObjects();
      const data = objects.map(obj => {
        if (obj.type === 'rect') {
          return {
            type: 'rect',
            left: obj.left,
            top: obj.top,
            width: obj.width,
            height: obj.height,
            customProps: obj.customProps,
            text: obj.text ? obj.text.text : ''
          };
        }
        return null;
      }).filter(obj => obj !== null);

      floors[currentFloor] = data;
    }
  }

  function loadFloor(name) {
    canvas.clear();
    if (floors[name]) {
      floors[name].forEach(roomData => {
        const room = new fabric.Rect({
          left: roomData.left,
          top: roomData.top,
          width: roomData.width,
          height: roomData.height,
          fill: 'rgba(100,150,240,0.3)',
          stroke: '#3399ff',
          strokeWidth: 2,
          hasControls: false,
          lockScalingX: true,
          lockScalingY: true,
        });
        room.customProps = roomData.customProps;

        const text = new fabric.Text(roomData.text, {
          left: room.left + room.width / 2 - 50,
          top: room.top + room.height / 2 - 20,
          fontSize: 18,
          textAlign: 'center',
          originX: 'center',
          originY: 'center',
          fill: 'black'
        });

        room.text = text;
        attachEventsToRoom(room);
        canvas.add(text);
        canvas.add(room);
      });
      canvas.renderAll();
    }
    canvas.add(originPoint);
    currentFloor = name;
    updateFloorListUI();
  }

  function updateFloorListUI() {
    const floorList = document.getElementById('floorList');
    floorList.innerHTML = '';
    for (const name in floors) {
      const div = document.createElement('div');
      div.className = 'floor-item' + (name === currentFloor ? ' active' : '');
      div.textContent = name;
      div.onclick = () => {
        saveCurrentFloor();
        loadFloor(name);
      };
      floorList.appendChild(div);
    }
  }

  document.getElementById('addFloor').onclick = () => {
    const floorNameInput = document.createElement('input');
    floorNameInput.id = 'floorNameInput';
    floorNameInput.placeholder = 'Geben Sie den Namen des Stockwerks ein...';
    floorNameInput.focus();

    const addButton = document.createElement('button');
    addButton.textContent = 'Erstellen';
    addButton.id = 'createFloorButton'; // <-- hinzufügen

    addButton.onclick = () => {
      const name = floorNameInput.value.trim();
      if (name) {
        floors[name] = [];
        loadFloor(name);
        document.getElementById('sidebar').removeChild(floorNameInput);
        document.getElementById('sidebar').removeChild(addButton);
      }
    };

    document.getElementById('sidebar').appendChild(floorNameInput);
    document.getElementById('sidebar').appendChild(addButton);
  };

  document.getElementById('deleteFloor').onclick = () => {
    if (currentFloor) {
      delete floors[currentFloor];
      const keys = Object.keys(floors);
      const next = keys.length > 0 ? keys[0] : null;
      currentFloor = null;
      loadFloor(next);
    }
  };

  document.getElementById('exportButton').onclick = () => {
    saveCurrentFloor();
    const data = JSON.stringify(floors, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'grundrisse.json';
    link.click();
  };

  document.getElementById('addRoom').onclick = () => {
    const room = new fabric.Rect({
      left: 100,
      top: 100,
      width: 4 * grid,
      height: 3 * grid,
      fill: 'rgba(100,150,240,0.3)',
      stroke: '#3399ff',
      strokeWidth: 2,
      hasControls: false,
      lockScalingX: true,
      lockScalingY: true,
    });
    room.customProps = { name: 'Raum', breite: 4, hoehe: 3, notiz: '', raumtyp: '' };

    const text = new fabric.Text(`${room.customProps.name}\n${room.customProps.breite * room.customProps.hoehe} m²`, {
      left: room.left + room.width / 2 - 50,
      top: room.top + room.height / 2 - 20,
      fontSize: 18,
      textAlign: 'center',
      originX: 'center',
      originY: 'center',
      fill: 'black'
    });

    room.text = text;
    attachEventsToRoom(room);
    canvas.add(text);
    canvas.add(room).setActiveObject(room);
  };

  function attachEventsToRoom(room) {
    room.on('selected', () => {
      selectedRoom = room;
      showPropertyForm(room);
    });
  }

  canvas.on('object:moving', function(e) {
    const moving = e.target;
    const objects = canvas.getObjects('rect').filter(obj => obj !== moving);

    objects.forEach(other => {
      const m = moving, o = other;

      const mL = m.left, mR = m.left + m.width, mT = m.top, mB = m.top + m.height;
      const oL = o.left, oR = o.left + o.width, oT = o.top, oB = o.top + o.height;

      if (Math.abs(mR - oL) < snapTolerance) m.left = oL - m.width;
      if (Math.abs(mL - oR) < snapTolerance) m.left = oR;
      if (Math.abs(mB - oT) < snapTolerance) m.top = oT - m.height;
      if (Math.abs(mT - oB) < snapTolerance) m.top = oB;



    });

    // Snapping an (0, 0) Punkt
    if (Math.abs(moving.left) < snapTolerance) {
        moving.left = 0;
      }
      if (Math.abs(moving.top) < snapTolerance) {
        moving.top = 0;
      }

    if (moving.text) {
      moving.text.set({
        left: moving.left + moving.width / 2 - 50,
        top: moving.top + moving.height / 2 - 20
      });
    }
  });

  const form = document.getElementById('propertyForm');
  const nameInput = document.getElementById('nameInput');
  const widthInput = document.getElementById('widthInput');
  const heightInput = document.getElementById('heightInput');
  const noteInput = document.getElementById('noteInput');
  const roomTypeInput = document.getElementById('roomTypeInput');
  let selectedRoom = null;

  function showPropertyForm(room) {
    selectedRoom = room;
    nameInput.value = room.customProps.name;
    widthInput.value = room.customProps.breite;
    heightInput.value = room.customProps.hoehe;
    noteInput.value = room.customProps.notiz || '';
    roomTypeInput.value = room.customProps.raumtyp || '';
    form.style.display = 'block';
  }

  document.getElementById('applyProps').onclick = () => {
    const name = nameInput.value.trim();
    const breite = parseFloat(widthInput.value);
    const hoehe = parseFloat(heightInput.value);
    const notiz = noteInput.value.trim();
    const raumtyp = roomTypeInput.value.trim();

    if (selectedRoom && name && !isNaN(breite) && !isNaN(hoehe)) {
      selectedRoom.customProps = { name, breite, hoehe, notiz, raumtyp };
      selectedRoom.set({
        width: breite * grid,
        height: hoehe * grid,
        scaleX: 1,
        scaleY: 1
      });
      selectedRoom.text.set({
        text: `${name}\n${breite * hoehe} m²`,
        left: selectedRoom.left + selectedRoom.width / 2 - 50,
        top: selectedRoom.top + selectedRoom.height / 2 - 20
      });
      canvas.renderAll();
    }
    form.style.display = 'none';
  };

  document.getElementById('deleteButton').onclick = () => {
    if (selectedRoom) {
      canvas.remove(selectedRoom);
      canvas.remove(selectedRoom.text);
      selectedRoom = null;
      form.style.display = 'none';
    }
  };

  let isDragging = false;
let lastPosX = 0;
let lastPosY = 0;
let isSpacePressed = false;

// Optional: Wenn du STRG oder Leertaste gedrückt halten willst für Dragging:
document.addEventListener('keydown', function(e) {
  if (e.code === 'Space') {
    isSpacePressed = true;
    canvas.defaultCursor = 'grab';
  }
});

document.addEventListener('keyup', function(e) {
  if (e.code === 'Space') {
    isSpacePressed = false;
    canvas.defaultCursor = 'default';
  }
});




canvas.on('mouse:down', function(opt) {
  // nur starten, wenn kein Objekt ausgewählt ist oder Leertaste gedrückt ist
  if (!canvas.getActiveObject() || isSpacePressed) {
    isDragging = true;
    lastPosX = opt.e.clientX;
    lastPosY = opt.e.clientY;
    canvas.selection = false;
    canvas.defaultCursor = 'grabbing';
  }
});

canvas.on('mouse:move', function(opt) {
  if (isDragging) {
    let deltaX = opt.e.clientX - lastPosX;
    let deltaY = opt.e.clientY - lastPosY;
    canvas.relativePan({ x: deltaX, y: deltaY });
    lastPosX = opt.e.clientX;
    lastPosY = opt.e.clientY;
  }
});

canvas.on('mouse:up', function() {
  isDragging = false;
  canvas.selection = true;
  canvas.defaultCursor = 'default';
});


  let zoomLevel = 1;
const ZOOM_STEP = 0.1;
const MIN_ZOOM = 0.2;
const MAX_ZOOM = 3;

  canvas.on('mouse:wheel', function(opt) {
  let delta = opt.e.deltaY;
  let zoom = canvas.getZoom();
  zoom *= 0.999 ** delta;
  zoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, zoom));

  canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
  opt.e.preventDefault();
  opt.e.stopPropagation();
});


  // Initiales Stockwerk
  document.getElementById('addFloor').click();
</script>

</body>
</html>