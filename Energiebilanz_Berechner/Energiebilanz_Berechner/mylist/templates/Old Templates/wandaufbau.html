{% load static %}
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Wandaufbau-Konfigurator</title>
  <style>
    html, body {
  margin: 0; padding: 0;
  width: 100%; height: 100%;
  font-family: 'Roboto', sans-serif;
  background-color: #f4f7fc;
  }

  /* UI Box */
  #ui {
    position: absolute;
    top: 20px; left: 20px;
    background: rgba(255, 255, 255, 0.97);
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    z-index: 100;
    width: 400px;
    max-height: 85%;
    overflow-y: auto;
  }

  /* Headings and Labels */
  h2 {
    font-size: 22px;
    margin-bottom: 16px;
    color: #222;
  }
  label {
    font-size: 14px;
    color: #444;
    font-weight: 500;
  }

  /* Inputs */
  select, input[type="number"] {
    width: 100%;
    padding: 10px;
    margin: 6px 0 12px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 14px;
    background-color: #fff;
    transition: border-color 0.2s ease;
  }
  select:focus, input[type="number"]:focus {
    border-color: #4CAF50;
    outline: none;
  }

  /* Button */
  button {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    color: white;
    background-color: #4CAF50;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  button:hover {
    background-color: #45a049;
  }

  /* Table */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background-color: #ffffff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
  }

  th, td {
    padding: 12px 14px;
    font-size: 14px;
    text-align: left;
  }

  th {
    background-color: #eef2f7;
    color: #333;
    font-weight: 600;
  }

  tbody tr:nth-child(odd) {
    background-color: #f9fbff;
  }

  tbody tr:nth-child(even) {
    background-color: #ffffff;
  }

  tbody tr:hover {
    background-color: #e6f2ff;
  }

  /* Action Buttons */
  .action-buttons {
    display: flex;
    justify-content: space-between;
    gap: 6px;
  }
  .action-buttons button {
    background-color: #f44336;
    width: auto;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 14px;
  }
  .action-buttons button:hover {
    background-color: #d32f2f;
  }

  /* U-Wert Anzeige */
  #uValueDisplay {
    margin-top: 20px;
    font-size: 18px;
    font-weight: bold;
    color: #333;
  }
  #uValueDisplay strong {
    color: #4CAF50;
  }

  canvas#renderCanvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
  }


  </style>
</head>
<body>

<div id="ui">
  <h2>Wandaufbau Konfigurator</h2>

  <label for="wallSelector">Wand ausw√§hlen:</label>
  <select id="wallSelector">
    <option value="Fassade Nord">Fassade Nord</option>
    <option value="Fassade S√ºd">Fassade S√ºd</option>
    <option value="Fassade West">Fassade West</option>
    <option value="Fassade Ost">Fassade Ost</option>
    <option value="Dach">Dach</option>
    <option value="Bodenplatte">Bodenplatte</option>
  </select>

  <label for="layerType">Schichttyp:</label>
  <select id="layerType">
    <option value="gipskarton">Gipskarton</option>
    <option value="mineralwolle">Mineralwolle</option>
    <option value="holz">Holz (KVH)</option>
    <option value="osb">OSB-Platte</option>
    <option value="folie">PE-Folie</option>
    <option value="bitumen">Bitumenbahn</option>
    <option value="ziegel">Ziegel</option>
    <option value="putz">Putz</option>
    <option value="beton">Beton</option>
  </select>

  <label for="layerThickness">Dicke (cm):</label>
  <input type="number" id="layerThickness" value="10" min="0.1" step="0.1">

  <button id="addLayer">Schicht hinzuf√ºgen</button>

  <div class="orientation-label">Innen</div>

  <table id="layerList">
    <thead>
      <tr>
        <th>#</th>
        <th>Typ</th>
        <th>Dicke (cm)</th>
        <th>R-Wert</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="orientation-label">Au√üen</div>

  <div id="uValueDisplay">U-Wert: -</div>
    <div class="nav-buttons" style="margin-top:20px; display:flex; gap:10px;">
    <a href="{% url 'startseite' %}" style="flex:1">
      <button type="button" style="width:100%">‚Üê Startseite</button>
    </a>
    <a href="{% url 'allg_angaben' %}" style="flex:1">
      <button type="button" style="width:100%">Weiter ‚Üí</button>
    </a>
  </div>
</div>

<canvas id="renderCanvas"></canvas>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script>
  const canvas = document.getElementById("renderCanvas");
  const engine = new BABYLON.Engine(canvas, true);
  const scene = new BABYLON.Scene(engine);
  scene.clearColor = new BABYLON.Color3(1, 1, 1);

  const camera = new BABYLON.ArcRotateCamera("camera", Math.PI / 2, Math.PI / 3, 30, new BABYLON.Vector3(0, 1, 0), scene);
  camera.attachControl(canvas, true);
  const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);

  const textureMap = {
    gipskarton:   "{% static 'textures/gipskarton.jpg' %}",
    mineralwolle: "{% static 'textures/daemmung.jpg' %}",
    holz:         "{% static 'textures/holz.jpg' %}",
    osb:          "{% static 'textures/osb.jpg' %}",
    folie:        "{% static 'textures/folie.jpg' %}",
    bitumen:      "{% static 'textures/bitumen.jpg' %}",
    ziegel:       "{% static 'textures/ziegel.jpg' %}",
    putz:         "{% static 'textures/putz.jpg' %}",
    beton:        "{% static 'textures/beton.jpg' %}"
  };

  const lambdaMap = {
    gipskarton: 0.25,
    mineralwolle: 0.035,
    holz: 0.13,
    osb: 0.13,
    folie: 0.3,
    bitumen: 0.17,
    ziegel: 0.8,
    putz: 0.87,
    beton: 2.1
  };

  const wallsData = {
    "Fassade Nord": [],
    "Fassade S√ºd": [],
    "Fassade West": [],
    "Fassade Ost": [],
    "Dach": [],
    "Bodenplatte": []
  };

  let currentWall = "Fassade Nord";

  function createFadeGround() {
    const ground = BABYLON.MeshBuilder.CreateGround("fadeGround", {
      width: 60,
      height: 60,
      subdivisions: 1
    }, scene);

    const shaderMaterial = new BABYLON.ShaderMaterial("fadeGroundShader", scene, {
      vertex: "fadeGround",
      fragment: "fadeGround"
    }, {
      attributes: ["position", "uv"],
      uniforms: ["worldViewProjection"]
    });

    shaderMaterial.backFaceCulling = false;
    shaderMaterial.alphaMode = BABYLON.Engine.ALPHA_COMBINE;
    shaderMaterial.disableDepthWrite = true; 

    ground.material = shaderMaterial;
    ground.position.y = 0;
  }



  function createLayer(type, thickness, xOffset) {
    const tex = textureMap[type];
    const layerWidth = thickness / 10;
    const size = 4;

    const material = new BABYLON.StandardMaterial("mat", scene);
    if (tex) {
      const texture = new BABYLON.Texture(tex, scene);
      texture.uScale = 1; texture.vScale = 1;
      material.diffuseTexture = texture;
      if (type === "folie") material.alpha = 0.5;
    } else {
      material.diffuseColor = new BABYLON.Color3(0.7, 0.7, 0.7);
    }

    const box = BABYLON.MeshBuilder.CreateBox("layer", {
      width: layerWidth,
      height: size,
      depth: size
    }, scene);

    box.position.x = xOffset + layerWidth / 2;
    box.position.y = size / 2;
    box.material = material;
    box.name = "layer";
    return box;
  }

  function rebuildWall() {
    scene.meshes.filter(m => m.name === "layer").forEach(m => m.dispose());
    let currentX = 0;
    wallsData[currentWall].forEach(layer => {
      createLayer(layer.type, layer.thickness, currentX);
      currentX += layer.thickness / 10;
    });
  }

  function updateLayerTable() {
    const tbody = document.querySelector("#layerList tbody");
    tbody.innerHTML = "";
    let totalR = 0;

    wallsData[currentWall].forEach((layer, index) => {
      const lambda = lambdaMap[layer.type];
      const d_m = layer.thickness / 100;
      const rValue = (lambda && d_m > 0) ? d_m / lambda : 0;
      totalR += rValue;

      const row = document.createElement("tr");
      row.setAttribute("draggable", "true");
      row.dataset.index = index;
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${layer.type}</td>
        <td>${layer.thickness}</td>
        <td>${rValue.toFixed(3)}</td>
        <td class="action-buttons">
          <button onclick="removeLayer(${index})">üóë</button>
        </td>
      `;

      row.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", index);
        row.classList.add("dragging");
      });

      row.addEventListener("dragend", () => {
        row.classList.remove("dragging");
      });

      row.addEventListener("dragover", (e) => {
        e.preventDefault();
        row.classList.add("drag-over");
      });

      row.addEventListener("dragleave", () => {
        row.classList.remove("drag-over");
      });

      row.addEventListener("drop", (e) => {
        e.preventDefault();
        const fromIndex = parseInt(e.dataTransfer.getData("text/plain"), 10);
        const toIndex = parseInt(row.dataset.index, 10);

        const arr = wallsData[currentWall];
        const moved = arr.splice(fromIndex, 1)[0];
        arr.splice(toIndex, 0, moved);

        updateLayerTable();
        rebuildWall();
      });

      tbody.appendChild(row);
    });

    const Rgesamt = totalR + 0.13 + 0.04;
    const uValue = Rgesamt > 0 ? (1 / Rgesamt).toFixed(3) : "-";
    document.getElementById("uValueDisplay").innerHTML = `<strong>U-Wert:</strong> ${uValue} W/m¬≤K`;
  }

  function addLayer() {
    const type = document.getElementById("layerType").value;
    const thickness = parseFloat(document.getElementById("layerThickness").value);
    if (thickness <= 0 || isNaN(thickness)) {
      alert("Ung√ºltige Dicke!");
      return;
    }

    wallsData[currentWall].push({ type, thickness });
    updateLayerTable();
    rebuildWall();
  }

  function switchWall(newWall) {
    currentWall = newWall;
    updateLayerTable();
    rebuildWall();
  }

  window.removeLayer = function(index) {
    wallsData[currentWall].splice(index, 1);
    updateLayerTable();
    rebuildWall();
  };

  document.getElementById("addLayer").addEventListener("click", addLayer);
  document.getElementById("wallSelector").addEventListener("change", e => switchWall(e.target.value));

  engine.runRenderLoop(() => scene.render());
  window.addEventListener("resize", () => engine.resize());

  BABYLON.Effect.ShadersStore["fadeGroundVertexShader"] = `
    precision highp float;
    // Attributes
    attribute vec3 position;
    attribute vec2 uv;
    uniform mat4 worldViewProjection;
    varying vec2 vUV;
    void main(void) {
      gl_Position = worldViewProjection * vec4(position, 1.0);
      vUV = uv;
    }
  `;

  BABYLON.Effect.ShadersStore["fadeGroundFragmentShader"] = `
    precision highp float;
    varying vec2 vUV;
    void main(void) {
      float dist = distance(vUV, vec2(0.5, 0.5));
      float alpha = smoothstep(0.45, 0.8, 1.0 - dist);
      vec3 color = vec3(0.8, 0.8, 0.8); // Hellgrau
      gl_FragColor = vec4(color, alpha * 0.5);
    }
  `;

  // Initial Setup
  updateLayerTable();
  rebuildWall();
  createFadeGround();
  

</script>
</body>
</html>